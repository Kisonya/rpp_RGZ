# Импортируем функцию create_app, которая создаёт Flask-приложение,
# и объект db (база данных) для работы с таблицами.
from app import create_app, db

# Импортируем модель пользователя, чтобы при старте приложения
# автоматически создать учётную запись администратора.
from app.models import User


# Создаём экземпляр приложения, вызвав заранее определённую функцию create_app().
app = create_app()


# Открываем контекст приложения.
# Это нужно, чтобы можно было работать с базой данных (db.create_all и запросы к моделям).
with app.app_context():
    # Создаём все таблицы в базе данных, если их ещё нет.
    db.create_all()

    # ---- Создаем администратора, если его нет ----
    # Пытаемся найти пользователя с логином "admin" в таблице user.
    admin = User.query.filter_by(username="admin").first()

    # Если такого пользователя ещё нет...
    if not admin:
        # ...создаём нового пользователя с логином "admin" и ролью "admin".
        admin = User(username="admin", role="admin")

        # Устанавливаем пароль "adminpass" (он будет сохранён в виде хеша).
        admin.set_password("adminpass")

        # Добавляем администратора в сессию базы данных.
        db.session.add(admin)

        # Сохраняем изменения в базе (записываем администратора в таблицу).
        db.session.commit()

        # Выводим сообщение в консоль на русском:
        # информируем, что администратор создан и какие логин/пароль.
        print("Создан администратор: логин admin / пароль adminpass")
    else:
        # Если администратор уже был в базе, выводим в консоль другое сообщение.
        print("Администратор уже существует")


# Этот блок выполняется, только если файл запущен напрямую:
# python run.py
if __name__ == "__main__":
    # Запускаем веб-сервер Flask в режиме отладки (debug=True).
    # В режиме отладки приложение автоматически перезапускается при изменении кода
    # и показывает подробные сообщения об ошибках.
    app.run(debug=True)
