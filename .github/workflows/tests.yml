# Название процесса автоматической проверки проекта, которое будет отображаться в GitHub
name: Проверка проекта

# Указываем, при каких событиях GitHub должен запускать автоматическую проверку
on:
  push:                   # Запускать при каждом "push" — то есть когда кто-то отправляет код в репозиторий
    branches: [ "main" ] # Но запускать проверку только если изменения отправлены в ветку main
  pull_request:           # Также запускать при создании Pull Request (когда кто-то предлагает изменения)
    branches: [ "main" ] # И снова — только если изменения направлены в ветку main

# Здесь описывается работа, которую GitHub выполнит автоматически
jobs:
  run-tests:
    name: Тестирование и анализ безопасности   # Имя задания, отображается в интерфейсе GitHub Actions
    runs-on: ubuntu-latest                     # GitHub запускает виртуальный компьютер с системой Ubuntu Linux

    steps:
      # ---------- ШАГ 1 ----------
      # Загружаем код проекта в эту виртуальную машину
      - name: Загрузка репозитория
        uses: actions/checkout@v4              # Специальная встроенная команда GitHub для получения файлов
  
      # ---------- ШАГ 2 ----------
      # Устанавливаем нужную версию Python
      - name: Установка Python
        uses: actions/setup-python@v5          # Готовый инструмент GitHub для установки Python
        with:
          python-version: "3.12"               # Версия Python, которую использует наш проект

      # ---------- ШАГ 3 ----------
      # Устанавливаем библиотеки, которые нужны проекту
      - name: Установка зависимостей
        run: |
          python -m pip install --upgrade pip  # Обновляем pip — менеджер библиотек Python
          pip install -r requirements.txt      # Устанавливаем все библиотеки, указанные в файле requirements.txt

      # ---------- ШАГ 4 ----------
      # Добавляем текущую папку в системную переменную PYTHONPATH,
      # чтобы Python мог находить модули (например, ourproject/app/...).
      - name: Добавление пути проекта (PYTHONPATH)
        run: echo "PYTHONPATH=$PWD" >> $GITHUB_ENV

      # ---------- ШАГ 5 ----------
      # Запускаем автоматические тесты проекта
      - name: Запуск unit-тестов (pytest)
        run: pytest -q                         # -q означает "quiet" — тихий вывод (меньше текста)

      # ---------- ШАГ 6 ----------
      # Проверяем безопасность Python-кода на наличие уязвимостей
      - name: Проверка безопасности кода (Bandit)
        run: bandit -r app -q                  # -r означает "проверять все папки рекурсивно"
